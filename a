

{
  description = "Legends of Runeterra (Riot Client) launcher wrapper for NixOS with heavy logging; robust winetricks shims for wrapped Wine";

  inputs.nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";

  outputs = { self, nixpkgs }:
    let
      systems = [ "x86_64-linux" "aarch64-linux" ];
      forAllSystems = f: nixpkgs.lib.genAttrs systems (system: f system);
    in
    {
      packages = forAllSystems (system:
        let
          pkgs = import nixpkgs { inherit system; config.allowUnfree = true; };

          winePkg = pkgs.wineWowPackages.stagingFull;

          runtimePkgs = with pkgs; [
            winePkg
            winetricks

            # winetricks helpers + debugging
            cabextract
            p7zip
            unzip
            curl
            wget
            file
            coreutils
            gnugrep
            gawk
            findutils
            which
            procps
            util-linux

            # headless fallback for wineboot/winetricks
            xorg.xvfb
            xorg.xauth

            # fontconfig (we also set cache dir)
            fontconfig
          ];
        in
        {
          lor = pkgs.writeShellApplication {
            name = "lor";
            runtimeInputs = runtimePkgs;

            text = ''
              #!/usr/bin/env bash
              set -euo pipefail

              # ----------------------------
              # Config (env overrides)
              # ----------------------------
              GAME_NAME="legends-of-runeterra"
              GAMEDIR="''${LOR_GAMEDIR:-$HOME/Games/$GAME_NAME}"
              PREFIX="''${LOR_PREFIX:-$GAMEDIR/prefix}"
              LOGDIR="''${LOR_LOGDIR:-$GAMEDIR/logs}"

              # Riot Client exe inside prefix
              RIOT_EXE_UNIX_DEFAULT="$PREFIX/drive_c/Riot Games/Riot Client/RiotClientServices.exe"
              RIOT_EXE_UNIX="''${LOR_RIOT_EXE:-$RIOT_EXE_UNIX_DEFAULT}"

              # LoR launch args used by community scripts
              # --launch-product=bacon --launch-patchline=live [4](https://gitmemories.com/NixOS/nixpkgs/issues/338367)[5](https://linuxvox.com/blog/league-on-linux/)
              RIOT_ARGS_DEFAULT=(--launch-product=bacon --launch-patchline=live)
              if [[ -n "''${LOR_RIOT_ARGS:-}" ]]; then
                # shellcheck disable=SC2206
                RIOT_ARGS=( $LOR_RIOT_ARGS )
              else
                RIOT_ARGS=("''${RIOT_ARGS_DEFAULT[@]}")
              fi

              # Winetricks deps typical for LoR: dotnet48 + wininet [4](https://gitmemories.com/NixOS/nixpkgs/issues/338367)[5](https://linuxvox.com/blog/league-on-linux/)
              WINETRICKS_VERBS_DEFAULT=(dotnet48 wininet)
              if [[ -n "''${LOR_WINETRICKS_VERBS:-}" ]]; then
                # shellcheck disable=SC2206
                WINETRICKS_VERBS=( $LOR_WINETRICKS_VERBS )
              else
                WINETRICKS_VERBS=("''${WINETRICKS_VERBS_DEFAULT[@]}")
              fi

              # Logging
              : "''${WINEDEBUG:=+timestamp,+pid,+seh}"
              export WINEDEBUG

              mkdir -p "$LOGDIR"
              TS="$(date -u +%Y%m%dT%H%M%SZ)"
              LOGFILE="$LOGDIR/lor-$TS.log"
              exec > >(tee -a "$LOGFILE") 2>&1

              info()  { echo "[INFO]  $*"; }
              warn()  { echo "[WARN]  $*"; }
              error() { echo "[ERROR] $*"; }
              die() { error "$*"; error "Logfile: $LOGFILE"; exit 1; }

              trap 'code=$?; [[ $code -eq 0 ]] && info "Done (exit 0). Log: $LOGFILE" || error "Failed (exit $code). Log: $LOGFILE"' EXIT

              mkdir -p "$GAMEDIR" "$PREFIX" "$LOGDIR"

              # Keep Wine-related caches local
              export XDG_DATA_HOME="$GAMEDIR/xdg-data"
              export XDG_CACHE_HOME="$GAMEDIR/xdg-cache"
              export XDG_CONFIG_HOME="$GAMEDIR/xdg-config"
              mkdir -p "$XDG_DATA_HOME" "$XDG_CACHE_HOME" "$XDG_CONFIG_HOME"

              # Fix Fontconfig "No writable cache directories" seen in your log [1](https://rezipdk-my.sharepoint.com/personal/ao_re-zip_com/Documents/Microsoft%20Copilot%20Chat%20Files/lor.txt)
              mkdir -p "$XDG_CACHE_HOME/fontconfig"
              chmod -R u+rwX "$XDG_CACHE_HOME" || true
              export FONTCONFIG_PATH="${pkgs.fontconfig.out}/etc/fonts"
              export FONTCONFIG_FILE="${pkgs.fontconfig.out}/etc/fonts/fonts.conf"
              export FC_CACHEDIR="$XDG_CACHE_HOME/fontconfig"

              export WINEPREFIX="$PREFIX"
              export WINEARCH="win64"
              export WINETRICKS_OPT_UNATTENDED=1

              have_display() { [[ -n "''${DISPLAY:-}" ]]; }
              run_with_display() {
                if have_display; then
                  "''${@}"
                else
                  warn "DISPLAY not set; running under Xvfb."
                  xvfb-run -a -s "-screen 0 1280x720x24" "''${@}"
                fi
              }

              # ----------------------------
              # Robust winetricks shim setup for NixOS
              # ----------------------------
              # Your failure still shows winetricks reading /nix/store/.../bin/wine and getting:
              #   "Unknown file arch" + "WoW64 type could not be detected" + empty %AppData% and abort. [1](https://rezipdk-my.sharepoint.com/personal/ao_re-zip_com/Documents/Microsoft%20Copilot%20Chat%20Files/lor.txt)
              # This matches known upstream issues where winetricks breaks when it inspects wrapper scripts. [2](https://www.youtube.com/watch?v=k0ZESqnNe7s)[3](https://wiki.takp.info/index.php/Getting_Started_on_Linux_Lutris_local_YAML)
              #
              # Fix: Make WINE point to a SHIM directory that contains wine/wine64/wineserver/wineserver64
              # and ensure those point at the real ELF binaries (.wine/.wineserver when present).
              #
              SHIMBIN="$GAMEDIR/shimbin"
              mkdir -p "$SHIMBIN"

              WINE_WRAPPER="$(command -v wine || true)"
              WINESERVER_WRAPPER="$(command -v wineserver || true)"
              [[ -n "$WINE_WRAPPER" ]] || die "wine not found in PATH"
              [[ -n "$WINESERVER_WRAPPER" ]] || die "wineserver not found in PATH"

              WINE_DIR="$(dirname "$WINE_WRAPPER")"
              WINESERVER_DIR="$(dirname "$WINESERVER_WRAPPER")"

              # Prefer real binaries if Nix provides .wine/.wineserver
              REAL_WINE="$WINE_WRAPPER"
              REAL_WINESERVER="$WINESERVER_WRAPPER"
              [[ -x "$WINE_DIR/.wine" ]] && REAL_WINE="$WINE_DIR/.wine"
              [[ -x "$WINESERVER_DIR/.wineserver" ]] && REAL_WINESERVER="$WINESERVER_DIR/.wineserver"

              # Provide wine/wine64 in same dir so winetricks finds them via WINE_BINDIR logic
              ln -sf "$REAL_WINE"      "$SHIMBIN/wine"
              ln -sf "$REAL_WINE"      "$SHIMBIN/wine64"
              ln -sf "$REAL_WINESERVER" "$SHIMBIN/wineserver"
              ln -sf "$REAL_WINESERVER" "$SHIMBIN/wineserver64"

              # Also expose wineboot/regedit/winecfg for convenience
              [[ -x "$WINE_DIR/wineboot" ]] && ln -sf "$WINE_DIR/wineboot" "$SHIMBIN/wineboot" || true
              [[ -x "$WINE_DIR/regedit"  ]] && ln -sf "$WINE_DIR/regedit"  "$SHIMBIN/regedit"  || true
              [[ -x "$WINE_DIR/winecfg"  ]] && ln -sf "$WINE_DIR/winecfg"  "$SHIMBIN/winecfg"  || true

              export PATH="$SHIMBIN:$PATH"

              # Crucial: force winetricks to use the shim path (not /nix/store/.../bin/wine wrapper)
              export WINE="$SHIMBIN/wine"
              export WINESERVER="$SHIMBIN/wineserver"
              export WINE_BIN="$SHIMBIN/wine"
              export WINESERVER_BIN="$SHIMBIN/wineserver"

              print_info() {
                info "== LoR Nix wrapper =="
                info "Timestamp (UTC): $TS"
                info "Logfile:        $LOGFILE"
                info "GAMEDIR:        $GAMEDIR"
                info "PREFIX:         $PREFIX"
                info "WINE:           $WINE"
                info "WINESERVER:     $WINESERVER"
                info "REAL_WINE:      $REAL_WINE"
                info "REAL_WINESERVER:$REAL_WINESERVER"
                info "WINEDEBUG:      $WINEDEBUG"
                info "Winetricks verbs: ''${WINETRICKS_VERBS[*]}"
                info "Riot exe:       $RIOT_EXE_UNIX"
                info "Riot args:      ''${RIOT_ARGS[*]}"
                info "DISPLAY:        ''${DISPLAY:-<unset>}"
              }

              wineserver_clean() {
                info "wineserver: kill + wait"
                "$WINESERVER" -k || true
                "$WINESERVER" -w || true
              }

              ensure_prefix() {
                if [[ -d "$PREFIX" && -f "$PREFIX/system.reg" ]]; then
                  info "Prefix exists: $PREFIX"
                  return 0
                fi
                info "Creating Wine prefix..."
                wineserver_clean
                run_with_display "$WINE" wineboot --init || die "wineboot --init failed"
                "$WINESERVER" -w || true
                run_with_display "$WINE" wineboot -u || true
                "$WINESERVER" -w || true
                info "Prefix created."
              }

              install_deps() {
                ensure_prefix
                wineserver_clean
                print_info

                info "Installing winetricks deps (very verbose)..."
                # keep temp dirs for debugging unless LOR_WINETRICKS_CLEAN=1
                if [[ -z "''${LOR_WINETRICKS_CLEAN:-}" ]]; then
                  WT_EXTRA=(--no-clean -v)
                else
                  WT_EXTRA=(-v)
                fi

                # Run winetricks under DISPLAY (or Xvfb)
                run_with_display winetricks "''${WT_EXTRA[@]}" -q "''${WINETRICKS_VERBS[@]}" || die "winetricks failed"
                "$WINESERVER" -w || true
                info "Dependencies installed."
              }

              run_installer() {
                install_deps
                local installer="''${1:-}"
                [[ -n "$installer" ]] || die "Usage: lor install /path/to/LoRInstaller.exe"
                [[ -f "$installer" ]] || die "Installer not found: $installer"

                wineserver_clean
                info "Launching installer: $installer"
                run_with_display "$WINE" "$installer" || die "Installer exited with error"
                "$WINESERVER" -w || true
                info "Installer finished."
                info "Next: lor run"
              }

              run_riot() {
                ensure_prefix
                wineserver_clean
                print_info

                [[ -f "$RIOT_EXE_UNIX" ]] || die "RiotClientServices.exe not found at: $RIOT_EXE_UNIX"
                info "Launching Riot Client..."
                run_with_display "$WINE" start /unix "$RIOT_EXE_UNIX" "''${RIOT_ARGS[@]}" || die "Riot launch failed"
              }

              cmd_shell() {
                ensure_prefix
                print_info
                info "Entering shell with env set."
                bash -i
              }

              cmd_logs() {
                info "Latest logs:"
                ls -1t "$LOGDIR"/lor-*.log 2>/dev/null | head -n 10 || true
                local latest
                latest="$(ls -1t "$LOGDIR"/lor-*.log 2>/dev/null | head -n 1 || true)"
                [[ -n "$latest" ]] && tail -n 200 -f "$latest" || warn "No logs found"
              }

              cmd_reset() {
                warn "This will DELETE: $PREFIX"
                warn "Type YES to continue:"
                read -r confirm
                if [[ "$confirm" == "YES" ]]; then
                  wineserver_clean
                  rm -rf "$PREFIX"
                  info "Prefix removed."
                else
                  info "Cancelled."
                fi
              }

              usage() {
                cat <<EOF
              lor â€” Legends of Runeterra wrapper for NixOS

              Commands:
                lor info
                lor deps
                lor install <LoRInstaller.exe>
                lor run
                lor shell
                lor logs
                lor reset
                lor help

              Notes:
                - We force winetricks to use a shim directory for wine/wine64/wineserver/wineserver64
                  to avoid NixOS wrapper-script arch detection failures. [1](https://rezipdk-my.sharepoint.com/personal/ao_re-zip_com/Documents/Microsoft%20Copilot%20Chat%20Files/lor.txt)[2](https://www.youtube.com/watch?v=k0ZESqnNe7s)[3](https://wiki.takp.info/index.php/Getting_Started_on_Linux_Lutris_local_YAML)
              EOF
              }

              main() {
                local cmd="''${1:-help}"
                shift || true
                case "$cmd" in
                  help|-h|--help) usage ;;
                  info) print_info ;;
                  deps) install_deps ;;
                  install) run_installer "''${1:-}" ;;
                  run) run_riot ;;
                  shell) cmd_shell ;;
                  logs) cmd_logs ;;
                  reset) cmd_reset ;;
                  *) die "Unknown command: $cmd (try: lor help)" ;;
                esac
              }

              echo "== LoR Nix wrapper =="
              echo "Timestamp (UTC): $TS"
              echo "Logfile: $LOGFILE"
              echo

              main "$@"
            '';
          };
        });

      apps = forAllSystems (system: {
        default = {
          type = "app";
          program = "${self.packages.${system}.lor}/bin/lor";
        };
      });
    };
}
